## __Platform Installation and Implementation__ 
(click Widget refresh to return to User Guide Index)  
Last updated on: 9/8/2023  
## Description  

This page provides guidance on Implementation. There are two primary components for setup and installation:  

1. Operations (Ops) Foundation (main platform)  (one CF template for primary region and one CF template for all secondary regions)
2. Tenant Accounts (where resources to be managed live) (one CF template for primary region and one CF template for all secondary regions) 

There are multiple deployment scenarios:  

1. Single AWS Account, where both components live.  
2. <<< Selected >>> Multi-Account, where one AWS account is typically the central operations management account, while managing resources in other AWS accounts. This scenario also supports managing resources within the management account.  
3. Any combination of these can also be used, where you have a mix of standalone accounts with the platform deployed and manage resources within in, while also having one or more accounts with the platform that manage other tenant accounts.  
4. Each AWS account can support multiple regions with one region as the "Central Monitoring Account" and all other regions as secondary regions. 

## Index:  

* Prerequisites and preparation  
* Ops Foundation Platform  
    * Installation  
    * Configuration  
* Tenant Accounts  
    * Installation  
    * Configuration  

***
## Prerequisites and Preparation  

### Steps:  

1. <<< Completed >>> Deploy the HCOM-CF-Ops-Foundation-Step-1.yml primer CloudFormation template in your central management aws account and region. Upload it from your workstation where you unzipped all the HCOM files. Enter your PrincipalOrgId and Owner tag email address. This will create the S3 Distribution bucket for staging all the HCOM platform deployment files and create parameters for use by the Step 2 CF template.  

2. <<< Completed >>> Copy the unzipped files to the S3 bucket created in step 1 by uploading using the AWS console to preserve the folder structure as described below. If you drag and drop the folders it will automatically create the folder structured described below.  
  
    - db  
        - copy \*.json into this folder  
    * docs  
        - copy \*.md into this folder  
    * lambdas  
        * copy all \*.zip files into this folder  
    * playbooks (optional - not required for deploying HCOM)  
        * ansible  
            * copy all Ansible playbook files (usually .yml)  
        * saltstack  
            * copy all Salt playbook / formula state files (usually .sls)  
        * _replace with custom folder_  
            * copy files here  
    * templates  
        * copy all HCOM-CF-\*  template files into this folder  
        * copy these files as well: amazon-cloudwatch-agent-ctl.ps1, amazon-cloudwatch-agent-ctl.sh, amazon-ssm-agent.json, custom-metric-status.txt  

        <<< Completed outputs >>>
CentralAccountOut	218803891742	Central HCOM Management account	HCOM-CentralAccount
CentralRegionOut	us-gov-west-1	Central HCOM Management Region for cenral Account	HCOM-CentralRegion
OwnerTagOut	sfinberg@outlook.com	HCOM Owner Tag is added when AWS resources are created	HCOM-OwnerTag
PrincipalOrgIdOut	o-cl2ap4dbzk	AWS Organization PrincipalOrgID	HCOM-PrincipalOrgID
        <<< Completed outputs >>>
        
2. Gather required information for use with the CloudFormation Templates to deploy the solution. Template: HCOM-CF-Ops-Foundation-Step-2.yaml

    * AWS PrincipalOrgID <<< o-cl2ap4dbzk >>> (usually something like o-xxxxxxxx). All AWS accounts must be part of this organization.
    * CentralTenantName <<< VDMS >>> this is the friendly name for the central mgmt account. Default is VDMS which aligns to DISA SCCA 
    * AWS IAM Role used by Platform Administrators to access and manage through AWS console. (must already exists and used by Platform Ops team) <<< platform-hcom-role1 >>>
        * Ex. for role with arn:aws-us-gov:iam::awsaccount:role/aws-reserved/sso.amazonaws.com/us-gov-west-1/AWSReservedSSO_AdministratorAccess_xxxxxxx, you would copy aws-reserved/sso.amazonaws.com/us-gov-west-1/AWSReservedSSO_AdministratorAccess_xxxxxxx
    * OwnerTag  - this is an AWS resource that will be added to track who owns all the AWS resources that will be created for the ops mgmt platform.
    * S3 bucket name for hosting reports generated by the platform. This will get created by the CF template. Usually something like, "msp-operations-reports-accountnumber-region'
    *   Lambda Architecture (for supported regions, use the arm option for lower cost, otherwise use default x86_64)
    *   LoadDatabase - this is done the first time only and deploys the json that was modified in the prequisites. This populates the platform database.

        <<< Completed outputs >>>
        CentralAccount	218803891742	Central HCOM Management account	CentralAccount
        CentralKMSKeyArn	arn:aws-us-gov:kms:us-gov-west-1:218803891742:key/mrk-ab2bb6b017d74501ae35e6e68fd415e9	KMS key ARN to be used by tenant accounts	CentralKmsKeyArn
        CentralRegion	us-gov-west-1	Central HCOM Management Region	CentralRegion
        <<< Completed outputs >>>

<<<< START >>>  3. Do a find/replace on platform-configuration.json found in the db folder for each of the following settings prior to deploying the CF templates:
    *   replace "000000000000" with the central management account AWS account number
    *   replace "o-xxxxxxxxxx" with the AWS PrincipalOrgID that all AWS accounts to be managed are part of
    *   replace "PrimaryRegion" with the primary region name (Ex. us-gov-east-1) in the central management account where the Ops Foundation template will be deployed.
    *   replace "SecondaryRegion" with the secondary region name (Ex. us-gov-west-1) in the central management account where the Ops Foundation Secondary template will be deployed.
    *   replace "AdminEmail" with the email of the primary Developer/Engineer supporting HCOM
    *   There are central platform settings called "centralaccount" on the first line of the JSON that you need to update that are not configurable at any other time without going into the database later. You specify if you want a central webhook for messaging, set the channel name and url and webhook to true. To disable set webhook to false. You control using a central SNS topic for alerts. There is a default topic that will be created automatically. You can change it here if you want to use an existing SNS Topic (just replace the current topic name with the one you want to use).
    *   Optional, replace central management Tenant name "VDMS" with your preferred tenant name for the management account where the HCOM platform Ops Foundation templates will be deployed
    *   Once you have made all the updates, save it and re-upload to the db folder in the distribution S3 bucket created in step 1.
***
## Ops Foundation Platform
## Installation in Central / Monitoring Account

This table providers guidance on which CloudFormation (CF) Template to use in a given AWS Account/Region scenario. If you plan to manage resources within the Central Monitoring Account, you will need to deploy the Tenant CF templates as well. The sample deployment scenario below has east region as the primary / central management region for deploying the HCOM solution with west as the secondary region.
<table>
<tr><th>Template</th><th>Account</th><th>Primary Region</th><th>Secondary Regions</th></tr>
<tr><td>HCOM-CF-Ops-Foundation-Step-1.yml</td><td>Central Management Account</td><td>us-gov-east-1</td><td>N/A</td></tr>
<tr><td>HCOM-CF-Ops-Foundation-Step-2.yml</td><td>Central Management Account</td><td>us-gov-east-1</td><td>N/A</td></tr>
<tr><td>HCOM-CF-Ops-foundation-step-3.yml</td><td>Central Management Account</td><td>N/A</td><td>us-gov-west-1</td></tr>
<tr><td>HCOM-CF-Tenant-Foundation-Step-4.yml</td><td>Tenant (different aws account) or Central (same aws account as Ops Foundation)</td><td>us-gov-east-1</td><td>N/A</td></tr>
<tr><td>HCOM-CF-Tenant-Foundation-Step-5.yml</td><td>Tenant (different aws account) or Central (same aws account as Ops Foundation)</td><td>N/A</td><td>us-gov-west-1</td></tr>
</table>

### Steps:


1. Deploy the HCOM-CF-Ops-Foundation-Step-2.yml CloudFormation template in your central management account. Point to this template in your S3 bucket, usually:

    `https://hcom-software-distribution-replacewithregion\_replacewithaccountnumber\_.s3-\_replacewithregion\_.amazonaws.com/templates/HCOM-CF-Foundation-Step-2.yml`  
    This deploys the core platform. Use all the information you collected in Step 1 above. Fill in the parameters when prompted, for the stack name use: HCOM-Ops-Foundation-Step-2, for all other screens accept the default settings and submit for processing.
2. Enable Cross-Account CloudWatch Monitoring. This is a manual step performed through the AWS console as there is no API to enable this. This is only performed in a multi-account setup. For Single account use, this step is not necessary.
    1. From the Central / Monitoring Account AWS console navigate to CloudWatch
    2. Click Settings in the bottom left menu
    3. Click the Configure button
    4. In the 'View cross-account cross-region', click the Edit button.
    5. The most common option here is to select 'Account Id Input' usually on the far right and click 'Save Changes' button.

### Configuration

### Tenant Accounts
1. Gather required information for use with the CloudFormation Template to deploy inside tenant AWS accounts. Template HCOM-CF-Tenant-Foundation-Step-4.yml. 
    * AWS PrincipalOrgID (usually something like o-xxxxxxxx). All AWS accounts must be part of this organization.
    * AWS account for the central or management account where the core ops platform will be deployed.
    * AWS region for the central or management account (corresponds to previous item)
    * OwnerTag this is an AWS resource that will be added to track who owns all the AWS resources that will be created for the ops mgmt platform.
    * Key ID for KMS Key created in the Ops Foundation Management Account.  The User alias for this key is HCOM-Key.  It is a Customer managed key.
2. Deploy the HCOM-CF-Tenant-Foundation-Step-4.yml CloudFormation template in your central / management account. Point to this template in your S3 bucket, usually:
3. Enable Cross-Account CloudWatch Monitoring. This is a manual step performed through the AWS console as there is no API to enable this. This is only performed in a multi-account setup. For Single account use, this step is not necessary.
    1. From the Tenant account AWS console navigate to CloudWatch
    2. Click Settings in the bottom left menu
    3. Click the Configure button
    4. Click 'Share data'
    5. Click 'Add account' then enter the AWS account for the central / management AWS account. 
    6. Leave all others as defaults and click 'Launch CloudFormation template'
    7. This will open a new browser tab: Type Confirm in the field and click 'Launch template'
    8. Click the 'I acknoledge...' box at the bottom and click 'Create stack' button. Wait for stack 'CloudWatch-CrossAccountShareRole' to complete.
    9. Now return to the browser tab for 'Share your CloudWatch data' that was left open so we can continue where we left off.
    10. Now click the 'Done' button
    11. Confirm in the 'Share your CloudWatch data' that the status is 'Shared'
4.  From the Central Management AWS console, navigate to CloudWatch Dashboards and select HCOM-Operations-Dashboard.
    *   During initial load you will be prompted to "Allow once" or "Allow always". Click Allow always for all the widgets. This authorizes the execution of the underlying AWS Lambda for each widget.


`https://hcom-software-distribution-\_replacewithaccountnumber\_.s3-\_replacewithregion\_.amazonaws.com/templates/HCOM-CF-Tenant-Foundation-secure.yml`
This deploys the core platform. Use all the information you collected in Step 1 above. Fill in the parameters when prompted, for the stack name use: HCOM-Ops-Foundation, for all other screens accept the default settings and submit for processing.

### Installation

### Steps:

1. Gather required information for use with the CloudFormation Templates to deploy the solution. Template: HCOM-CF-Tenant-Foundation-secure.yml

    1. AWS PrincipalOrgID (usually something like o-xxxxxxxx). All AWS 2. accounts must be part of this organization.
    AWS account for the central or management account where the core ops platform will be deployed.
    2. AWS region for the central or management account (corresponds to previous item)
    3. OwnerTag this is an AWS resource that will be added to track who owns all the AWS resources that will be created for the ops mgmt platform.
2. Deploy the HCOM-CF-Tenant-Foundation-secure.yml CloudFormation template in your central or management account. Point to this template in your S3 bucket, usually:

`https://msp-software-distribution-\_replacewithaccountnumber\_.s3-\_replacewithregion\_.amazonaws.com/templates/HCOM-CF-Tenant-Foundation-secure.yml`
This deploys the AWS resources for tenant accounts where resources exist to be managed by the Ops Mgmt Platform. Use all the information you collected in Step 1 above. Fill in the parameters when prompted, for the stack name use: HCOM-Tenant-Foundation, for all other screens accept the default settings and submit for processing.

***
## Configuration

### On-Premise Instance Support

#### Linux (CentOS was tested, login to on-premise instance with ssh)
### Steps:
1. Create credential keys in AWS console IAM for user HCOM-onprem-user. Select options for AWS cli use.
2. Install and configuration SSM Agent & AWS cli, optional install configuration management agent such as SaltStack (example included), Ansible or other agent. Use and customize the following script.

    `#! /bin/bash`  
    `# bootstarp on-prem server`  
    `## update OS, install Python, pip`  
    `sudo yum -y update`  
    `sudo  yum -y install python3`  
    `sudo yum -y install python2-pip`  
    `sudo  yum -y install python3-pip`  
    `## install aws cli and credentials`  
    `pip3 install awscli --upgrade --user # us this method as non-root - use zip method as root`  
    `## or run aws configure --profile AmazonCloudWatchAgent`
    `sudo mkdir /root/.aws`  
    `sudo echo "[profile AmazonCloudWatchAgent]" >> /root/.aws/config`  
    `sudo echo "region = us-gov-east-1" >> /root/.aws/config`  
    `sudo echo "[default]" >> /root/.aws/config`  
    `sudo echo "region = us-gov-east-1" >> /root/.aws/config`  
    `aws configure set default.region us-gov-east-1; aws configure set aws_access_key_id \'replace with actual key\'; aws configure set aws_secret_access_key replace with actual key;`  

    `# write aws cli cred file`  
    `sudo echo "[AmazonCloudWatchAgent]" >> /root/.aws/credentials`  
    `sudo echo "aws_access_key_id = replace_with_id" >> /root/.aws/credentials`  
    `sudo echo "aws_secret_access_key = replace_with_id" >> /root/.aws/credentials`  

    `## install salt for configuration management`  
    `#pip3 install --user salt`  
    `sudo curl -L https://bootstrap.saltproject.io | sudo sh -s --`  
    `sudo systemctl enable salt-minion`  
    `sudo systemctl start salt-minion`  
    `## download SSM Agent for CentOS`  
    `wget https://s3.us-gov-east-1.amazonaws.com/amazon-ssm-us-gov-east-1/latest/linux_amd64/amazon-ssm-agent.rpm`  

    `## install `  
    `#sudo dnf install -y amazon-ssm-agent`  
    `sudo rpm -Uhv amazon-ssm-agent.rpm`  

3. Create SSM Hybrid Activation (can modify descrpition, instance name and tags)
    `aws ssm create-activation --description replace_with_desc --default-instance-name replace_with_name --iam-role`  `HCOM-AmazonEC2RunCommandRoleForManagedInstances --tags Key=CloudWatch-Profile,Value=replace_with_number`  
4. Register Instance (get output from step 3, code and id and use below)
    `sudo -E amazon-ssm-agent -register -code "replace_with_code" -id "replace_with_id" -region "us-gov-east-1"`  
5. start process and set to autostart at boot
    `sudo systemctl start amazon-ssm-agent`  
    `sudo systemctl enable amazon-ssm-agent`  
6. You may want to give it sometime for SSM agent to phone home and fully work. It may report Online in console right away but local ssm-cli may not report status for 1 or more hours. Once it does the SSM Run document that syncs configuration should start working.  
7. Lots of things can go wrong here and there may be a learning curve to getting SSM agent fully working in your environment. Lean on AWS support to help navigate.  
8. Install CloudWatch Agent - use SSM Run Document: AWS-ConfigureAWSPackage, specify AmazonCloudWatchAgent, select target instance. 
9. Create CloudWatchAgent configuration and credentials: Linux: sudo aws configure --profile AmazonCloudWatchAgent; Windows: aws configure --profile AmazonCloudWatchAgent 
9. Configure CloudWatch Agent - use SSM Run Document: AmazonCloudWatch-ManageAgent. Make sure to select onPremise from drop-down and specific parameter store name for profile.  
    *   If necessary manual configure from command line: Linux: sudo amazon-cloudwatch-agent-ctl -a fetch-config -m onPremise -s -c ssm:CloudWatch-Profile-5; Windows: & ".\amazon-cloudwatch-agent-ctl.ps1" -a fetch-config -m onpremise -s -c ssm:CloudWatch-Profile-7"  


## Windows (Win 2022 was tested)
### Steps:
1. Create credential keys in AWS console IAM for user HCOM-onprem-user. Select options for AWS cli use. (does not need to be repeated if already created. This is done once per AWS account)
2. Rename (if needed) Windows System name in OS and reboot. This will be used by SSM as "Instance Name"
3. Downlaod and install SSM Agent. Use and customize the following PowerShell commands from shell with administrator permission.
    

    `# configure powershell for AWS`  
    `Set-PSRepository (when prompted type PSGallery)`  
    `Install-Module -Name AWS.Tools.Installer -Force`  
    `Install-Module -Name AWSPowerShell`  
    `# download and install AWS cli`  
    `msiexec.exe /i https://awscli.amazonaws.com/AWSCLIV2.msi /qn`  
    `# you will need to start a new shell session after aws cli is installed`  
    `# configure AWS cli - use keys when prompted and set region to appropriate region for instance# create SSM Hybrid Activation`  
    `New-SSMActivation -DefaultInstanceName replace_name -Description replace_description -IamRole HCOM-AmazonEC2RunCommandRoleForManagedInstances -RegistrationLimit 10 -Region us-gov-east-1`  
    `# install Systems Manager Agent`  
    `### Use the code and id from previous step and insert in code below to install and register instance for Windows. replace code, id, region to match activation`  
    `$code = "replace_with_code"`  
    `$id = "replace_with_id"`  
    `$region = "us-gov-east-1"`  
    `$dir = $env:TEMP + "\ssm"`  
    `New-Item -ItemType directory -Path $dir -Force`  
    `cd $dir`  
    `(New-Object System.Net.WebClient).DownloadFile("https://amazon-ssm-$region.s3.$region.amazonaws.com/latest/windows_amd64/AmazonSSMAgentSetup.exe", $dir + "\AmazonSSMAgentSetup.exe")`  
    `Start-Process .\AmazonSSMAgentSetup.exe -ArgumentList @("/q", "/log", "install.log", "CODE=$code", "ID=$id", "REGION=$region") -Wait`  

4. Change the user the SSM Agent runs as to user with permission to write files to SSM location and create startup automation task in Task Scheduler.
5. with admin PowerShell, configure profile for CloudWatch Agent (without this, the Agent cannot be configure and started)
    * `aws configure --profile AmazonCloudWatchAgent` 
6. Copy users (currently logged in user other and administrator) C:\Users\Administrator\.aws folder to the local Administrators folder
6. Start instance to trigger alarm creation and/or use SSM Run Document to push config and start agent.
7. If Windows start events is not triggering alerm creation you may need to run the following commands on the instance in Powershell as administrator to create the Start-Event task in Task Scheduler properly.
    *   `Unregister-ScheduledJob StartEvent`
    *   `$trigger = New-JobTrigger -AtStartup -RandomDelay 00:00:30;`
    *   `Register-ScheduledJob -Trigger $trigger -FilePath C:\ProgramData\Amazon\SSM\Download\start.ps1 -Name StartEvent;`


Use docs at: [CloudWatch Unified Cross Account Setup](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Unified-Cross-Account-Setup.html#Unified-Cross-Account-Setup-ConfigureMonitoringAccount)  
Step 3 Link the source account
